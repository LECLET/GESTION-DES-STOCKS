<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>GESTION DE STOCK — ARTEMIS Security</title>
<link rel="stylesheet" href="styles.css">
<script src="https://cdn.jsdelivr.net/npm/localforage@1/dist/localforage.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
<header class="hidden" id="hdr">
  <img src="logo.webp" alt="ARTEMIS">
  <h1>GESTION DE STOCK — ARTEMIS Security</h1>
  <span class="badge" id="bAgency"></span>
  <span class="badge" id="bRole"></span>
  <div class="right">
    <select id="agencySwitch" class="hidden"></select>
    <button id="btnLogout" class="ghost">Déconnexion</button>
  </div>
</header>

<div id="login" class="container">
  <div class="card" style="max-width:520px;margin:10vh auto">
    <div class="grid">
      <img src="logo.webp" alt="logo" style="height:60px;border-radius:8px">
      <h2>Connexion</h2>
      <input id="lUser" placeholder="Identifiant">
      <input id="lPass" type="password" placeholder="Mot de passe">
      <button id="btnLogin" class="primary">Se connecter</button>
      <span class="small">Aucun indice n’est affiché sur cette page.</span>
    </div>
  </div>
</div>

<div id="app" class="container hidden">
  <div class="tabs" id="tabs"></div>

  <div id="tab-catalogue" class="card">
    <div class="card" id="catStats" style="margin-top:8px">
      <h3>Statistiques (sélection)</h3>
      <div class="table-wrap" style="max-height:220px">
        <table id="catStatsTbl"><thead><tr><th>Famille</th><th>Catégorie</th><th>Articles</th><th>Qté</th><th>Valorisation</th></tr></thead><tbody></tbody></table>
      </div>
    </div>

    <div class="kpi">
      <div class="item"><div>Total articles</div><div id="kTotal" style="font-size:22px;font-weight:800"></div></div>
      <div class="item"><div>Valorisation (sélection)</div><div id="kValo" style="font-size:22px;font-weight:800"></div></div>
      <div class="item admin-only"><div>Valorisation (TOUT)</div><div id="kValoAll" style="font-size:22px;font-weight:800"></div></div>
      <div class="item"><div>Sous seuil (agence courante)</div><div id="kLow" style="font-size:22px;font-weight:800"></div></div>
    </div>
    <div class="grid g3">
      <div class="card">
        <h3>Filtres</h3>
        <div class="grid g3">
          <input id="fSearch" placeholder="Nom, référence, code-barres">
          <select id="fFamily"></select>
          <select id="fCategory"></select>
          <div>
            <label>Agences</label>
            <select id="fAgencies" multiple size="6"></select>
            <button id="fAll" class="ghost" style="margin-top:6px">TOUT</button>
          </div>
          <select id="fReassort">
            <option value="">Tous</option>
            <option value="1">À réassort (par taille)</option>
          </select>
          <div class="right">
            <label>Page</label>
            <select id="fPageSize"><option>20</option><option>50</option><option>100</option></select>
          </div>
        </div>
      </div>
      <div class="card">
        <h3>Actions</h3>
        <div class="grid g3">
          <button id="btnReassort" class="primary">Proposer un réassort</button>
          <button id="btnReassortGen" class="ghost">Générer Entrées</button>
          <div class="right admin-only">
            <button id="expX" class="ghost">Export Produits (XLSX)</button>
            <input id="impX" type="file" accept=".xlsx">
          </div>
        </div>
      </div>
    </div>
    <div class="table-wrap card">
      <table id="catTbl">
        <thead><tr>
          <th>Référence</th><th>Article</th><th>Famille</th><th>Catégorie</th>
          <th>Prix (€/u)</th><th>Stock (sélection)</th><th class="admin-only">Stock (TOUT)</th>
          <th>Seuil (agence courante)</th><th>Code-barres</th><th>Affectation</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="pagination">
        <button id="pPrev" class="ghost">◀</button>
        <span id="pInfo">1/1</span>
        <button id="pNext" class="ghost">▶</button>
      </div>
    </div>
    <div class="right"><button id="btnNewFromCat" class="ghost">+ Nouveau produit</button></div>
  </div>

  <div id="tab-produit" class="card hidden">
    <h3 id="pTitle">Fiche produit</h3>
    <div class="grid g3">
      <input id="pRef" placeholder="Référence">
      <input id="pName" placeholder="Libellé">
      <select id="pFamily"></select>
      <select id="pCategory"></select>
      <input id="pPrice" type="number" min="0" step="0.01" placeholder="Prix d'achat">
      <input id="pVendor" placeholder="Revendeur">
      <input id="pBarcode" placeholder="Code-barres / QR">
      <input id="pAffectation" placeholder="Affectation (libre)">
    </div>
    <div class="grid g3">
      <input id="pMinGlobal" type="number" min="0" step="1" placeholder="Seuil mini global">
      <label><input id="pSizesToggle" type="checkbox"> Seuils par taille</label>
      <span></span>
    </div>
    <div id="pSizesWrap" class="grid g4 hidden"></div>
    <div class="card"><h4>Notes</h4><textarea id="pNotes" placeholder="Notes libres"></textarea></div>
    <div class="grid g2">
      <div class="card">
        <h4>Photo</h4>
        <input id="pPhoto" type="file" accept="image/*"><br>
        <img id="pPhotoPrev" class="hidden" style="max-height:100px;border-radius:8px;border:1px solid #334155">
      </div>
      <div class="card">
        <h4>Fiche technique (PDF)</h4>
        <input id="pTech" type="file" accept="application/pdf"><br>
        <a id="pTechLink" class="hidden" target="_blank">Ouvrir fiche</a>
      </div>
    </div>
    <div class="grid g3">
      <button id="btnSaveP" class="primary">Enregistrer</button>
      <button id="btnNewP" class="ghost">Nouveau</button>
      <button id="btnDelP" class="danger hidden">Supprimer</button>
    </div>
  </div>

  <div id="tab-mv" class="card hidden">
    <h3>Mouvements</h3>
    <div class="grid g4">
      <select id="mType"><option value="in">Entrée</option><option value="out">Sortie</option><option value="transfer">Transfert</option></select>
      <datalist id="mRefList"></datalist>
      <input list="mRefList" id="mRefSearch" placeholder="Réf — nom (recherche)">
      <select id="mRef"></select>
      <input id="mQty" type="number" min="1" step="1" placeholder="Quantité">
      <select id="mSize"></select>
      <label><input id="mMulti" type="checkbox"> Multi-tailles</label>
      <div id="mMultiWrap" class="grid g4 hidden"></div>
      <div>
        <label>Destinataire</label>
        <select id="mDest"></select>
        <div class="grid"><input id="mDestAdd" placeholder="Nouveau destinataire"><button id="mDestBtn" class="ghost">+</button></div>
      </div>
      <div>
        <label>Motif</label>
        <select id="mMotif"></select>
        <div class="grid"><input id="mMotifAdd" placeholder="Nouveau motif"><button id="mMotifBtn" class="ghost">+</button></div>
      </div>
      <input id="mNote" placeholder="N° bon, commentaire…">
      <select id="mTo" class="hidden"></select>
      <button id="mAdd" class="primary">Ajouter</button>
    </div>
    <hr>
    <div class="grid">
      <input id="mFilter" placeholder="Filtrer l'historique">
      <div class="right">
        <button id="mExp" class="ghost admin-only">Export XLSX</button>
        <button id="mPurge" class="danger admin-only">Purger l'historique (agence courante)</button>
      </div>
    </div>
    <div class="table-wrap card" style="max-height:360px">
      <table id="mTbl"><thead><tr><th>Date</th><th>Type</th><th>Agence</th><th>Réf</th><th>Taille</th><th>Qté</th><th>Vers</th><th>Dest.</th><th>Motif</th><th>Note</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div id="tab-stats" class="card hidden">
    <h3>Statistiques</h3>
    <div class="grid g3">
      <input id="sFrom" type="date">
      <input id="sTo" type="date">
      <div>
        <label>Agences</label>
        <select id="sAgencies" multiple size="6"></select>
        <button id="sAll" class="ghost" style="margin-top:6px">TOUT</button>
      </div>
      <button id="sRun" class="primary">Calculer</button>
    </div>
    <div class="table-wrap card" style="max-height:420px">
      <table id="sTbl"><thead><tr><th>Référence</th><th>Article</th><th>Famille</th><th>Catégorie</th><th>Stock (sélection)</th><th>Valorisation</th><th>Entrées</th><th>Sorties</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div id="tab-admin" class="card hidden">
    <h3>Administration</h3>
    <div class="grid g3">
      <div class="card">
        <h4>Agences</h4>
        <div class="grid"><input id="aNew" placeholder="Nouvelle agence"><button id="aAdd">Ajouter</button></div>
        <ul id="aList"></ul>
      </div>
      <div class="card">
        <h4>Utilisateurs</h4>
        <div class="grid">
          <input id="uUser" placeholder="Identifiant">
          <input id="uPass" placeholder="Mot de passe">
          <select id="uRole"><option value="admin">admin</option><option value="agence">agence</option></select>
          <label>Agences autorisées</label>
          <select id="uAgs" multiple size="8"></select>
          <div class="grid g3">
            <button id="uSave" class="primary">Créer/Mettre à jour</button>
            <button id="uDel" class="danger">Supprimer</button>
          </div>
        </div>
        <table id="uTbl"><thead><tr><th>User</th><th>Rôle</th><th>Agences</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="card">
        <h4>Import / Export</h4>
        <div class="grid">
          <button id="eJSON">Export JSON complet</button>
          <input id="iJSON" type="file" accept=".json">
          <hr>
          <button id="eXLSX">Export Produits (FULL XLSX)</button>
          <input id="iXLSX" type="file" accept=".xlsx">
        </div>
      </div>
    </div>
  </div>

</div>

<footer>ARTEMIS Security — Cloud Firestore par défaut, fallback local si indisponible.</footer>
<script src="app.js"></script>
</body>
</html>
