<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>GESTION DE STOCK — ARTEMIS Security</title>
<style>
:root{--bg:#0f172a;--panel:#111827;--muted:#94a3b8;--text:#e5e7eb;--border:#1f2937;--accent:#10b981}
*{box-sizing:border-box}html,body{margin:0;height:100%;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
body{background:linear-gradient(180deg,#0b1222 0,#0f172a 30%,#0b1222 100%);color:var(--text)}
header{display:flex;gap:12px;align-items:center;padding:12px 16px;background:rgba(17,24,39,.9);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:5}
header img{height:40px;border-radius:8px}
h1{font-size:18px;margin:0;font-weight:800}
.badge{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid var(--border);color:#cbd5e1;background:#0b1222;font-size:12px}
.container{max-width:1200px;margin:0 auto;padding:16px}
.card{background:rgba(17,24,39,.85);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.35);padding:14px;margin-bottom:12px}
.grid{display:grid;gap:10px}.g2{grid-template-columns:repeat(2,minmax(0,1fr))}.g3{grid-template-columns:repeat(3,minmax(0,1fr))}.g4{grid-template-columns:repeat(4,minmax(0,1fr))}
@media(max-width:1100px){.g2,.g3,.g4{grid-template-columns:1fr}}
input,select,button,textarea{background:#0b1222;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 10px;font-size:14px}
button{cursor:pointer}button.primary{background:linear-gradient(180deg,#10b981,#059669);border-color:#0ea5a4;color:#052d2b;font-weight:700}
button.ghost{background:transparent;border-color:#233046}
button.danger{background:linear-gradient(180deg,#ef4444,#b91c1c);border-color:#7f1d1d;color:#fff}
.tabs{display:flex;gap:8px;margin:8px 0 12px} .tabs button{border:1px solid var(--border)} .tabs .active{background:#1f2937;color:#fff}
.table-wrap{max-height:460px;overflow:auto;border-radius:12px;border:1px solid var(--border)}
table{width:100%;border-collapse:collapse}th,td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left;font-size:13px}
th{position:sticky;top:0;background:#0b1222;z-index:1}
tr:hover td{background:#101a30}
.kpi{display:flex;gap:10px;flex-wrap:wrap}.kpi .item{flex:1 1 180px;background:#0b1222;border:1px solid var(--border);border-radius:12px;padding:10px}
.small{font-size:12px;color:#94a3b8}
.hidden{display:none!important}.right{margin-left:auto}
.cell{display:inline-block;min-width:60px;padding:2px 6px;border:1px dashed #334155;border-radius:6px}
.warn{background:#3a2a00}.alert{background:#3a1111}
.pagination{display:flex;gap:8px;justify-content:flex-end;align-items:center;padding:8px 0}
footer{padding:16px;text-align:center;color:#94a3b8;font-size:12px}
</style>
<script src="https://cdn.jsdelivr.net/npm/localforage@1/dist/localforage.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
<header class="hidden" id="hdr">
  <img src="data:image/jpeg;base64,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" alt="ARTEMIS">
  <h1>GESTION DE STOCK — ARTEMIS Security</h1>
  <span class="badge" id="bAgency"></span>
  <span class="badge" id="bRole"></span>
  <div class="right">
    <select id="agencySwitch" class="hidden"></select>
    <button id="btnLogout" class="ghost">Déconnexion</button>
  </div>
</header>

<div id="login" class="container">
  <div class="card" style="max-width:520px;margin:10vh auto">
    <div class="grid">
      <img src="data:image/jpeg;base64,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" alt="logo" style="height:60px;border-radius:8px">
      <h2>Connexion</h2>
      <input id="lUser" placeholder="Identifiant">
      <input id="lPass" type="password" placeholder="Mot de passe">
      <button id="btnLogin" class="primary">Se connecter</button>
      <span class="small">Aucun indice n’est affiché sur cette page conformément à ta demande.</span>
    </div>
  </div>
</div>

<div id="app" class="container hidden">
  <div class="tabs" id="tabs"></div>

  <!-- Catalogue -->
  <div id="tab-catalogue" class="card">
    <div class="kpi">
      <div class="item"><div>Total articles</div><div id="kTotal" style="font-size:22px;font-weight:800"></div></div>
      <div class="item"><div>Valorisation (sélection)</div><div id="kValo" style="font-size:22px;font-weight:800"></div></div>
      <div class="item admin-only"><div>Valorisation (TOUT)</div><div id="kValoAll" style="font-size:22px;font-weight:800"></div></div>
      <div class="item"><div>Sous seuil (agence courante)</div><div id="kLow" style="font-size:22px;font-weight:800"></div></div>
    </div>

    <div class="grid g3">
      <div class="card">
        <h3>Filtres</h3>
        <div class="grid g3">
          <input id="fSearch" placeholder="Nom, référence, code-barres">
          <select id="fFamily"></select>
          <select id="fCategory"></select>
          <div>
            <label>Agences</label>
            <select id="fAgencies" multiple size="6"></select>
            <button id="fAll" class="ghost" style="margin-top:6px">TOUT</button>
          </div>
          <select id="fReassort">
            <option value="">Tous</option>
            <option value="1">À réassort (par taille)</option>
          </select>
          <div class="right">
            <label>Page</label>
            <select id="fPageSize"><option>20</option><option>50</option><option>100</option></select>
          </div>
        </div>
      </div>
      <div class="card">
        <h3>Actions</h3>
        <div class="grid g3">
          <button id="btnReassort" class="primary">Proposer un réassort</button>
          <button id="btnReassortGen" class="ghost">Générer Entrées</button>
          <div class="right admin-only">
            <button id="expX" class="ghost">Export Produits (XLSX)</button>
            <input id="impX" type="file" accept=".xlsx">
          </div>
        </div>
      </div>
    </div>

    <div class="table-wrap card">
      <table id="catTbl">
        <thead><tr>
          <th>Référence</th><th>Article</th><th>Famille</th><th>Catégorie</th>
          <th>Prix (€/u)</th><th>Stock (sélection)</th><th class="admin-only">Stock (TOUT)</th>
          <th>Seuil (agence courante)</th><th>Code-barres</th><th>Affectation</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="pagination">
        <button id="pPrev" class="ghost">◀</button>
        <span id="pInfo">1/1</span>
        <button id="pNext" class="ghost">▶</button>
      </div>
    </div>
  </div>

  <!-- Produit -->
  <div id="tab-produit" class="card hidden">
    <h3 id="pTitle">Fiche produit</h3>
    <div class="grid g3">
      <input id="pRef" placeholder="Référence">
      <input id="pName" placeholder="Libellé">
      <select id="pFamily"></select>
      <select id="pCategory"></select>
      <input id="pPrice" type="number" min="0" step="0.01" placeholder="Prix d'achat">
      <input id="pVendor" placeholder="Revendeur">
      <input id="pBarcode" placeholder="Code-barres / QR">
      <input id="pAffectation" placeholder="Affectation (libre)">
    </div>
    <div class="grid g3">
      <input id="pMinGlobal" type="number" min="0" step="1" placeholder="Seuil mini global">
      <label><input id="pSizesToggle" type="checkbox"> Seuils par taille</label>
      <span></span>
    </div>
    <div id="pSizesWrap" class="grid g4 hidden"></div>
    <div class="card"><h4>Notes</h4><textarea id="pNotes" placeholder="Notes libres"></textarea></div>
    <div class="grid g2">
      <div class="card">
        <h4>Photo</h4>
        <input id="pPhoto" type="file" accept="image/*"><br>
        <img id="pPhotoPrev" class="hidden" style="max-height:100px;border-radius:8px;border:1px solid #334155">
      </div>
      <div class="card">
        <h4>Fiche technique (PDF)</h4>
        <input id="pTech" type="file" accept="application/pdf"><br>
        <a id="pTechLink" class="hidden" target="_blank">Ouvrir fiche</a>
      </div>
    </div>
    <div class="grid g3">
      <button id="btnSaveP" class="primary">Enregistrer</button>
      <button id="btnNewP" class="ghost">Nouveau</button>
      <button id="btnDelP" class="danger hidden">Supprimer</button>
    </div>
  </div>

  <!-- Mouvements -->
  <div id="tab-mv" class="card hidden">
    <h3>Mouvements</h3>
    <div class="grid g4">
      <select id="mType"><option value="in">Entrée</option><option value="out">Sortie</option><option value="transfer">Transfert</option></select>
      <datalist id="mRefList"></datalist>
      <input list="mRefList" id="mRefSearch" placeholder="Réf — nom (recherche)">
      <select id="mRef"></select>
      <input id="mQty" type="number" min="1" step="1" placeholder="Quantité">
      <select id="mSize"></select>
      <label><input id="mMulti" type="checkbox"> Multi-tailles</label>
      <div id="mMultiWrap" class="grid g4 hidden"></div>
      <div>
        <label>Destinataire</label>
        <select id="mDest"></select>
        <div class="grid"><input id="mDestAdd" placeholder="Nouveau destinataire"><button id="mDestBtn" class="ghost">+</button></div>
      </div>
      <div>
        <label>Motif</label>
        <select id="mMotif"></select>
        <div class="grid"><input id="mMotifAdd" placeholder="Nouveau motif"><button id="mMotifBtn" class="ghost">+</button></div>
      </div>
      <input id="mNote" placeholder="N° bon, commentaire…">
      <select id="mTo" class="hidden"></select>
      <button id="mAdd" class="primary">Ajouter</button>
    </div>
    <hr>
    <div class="grid">
      <input id="mFilter" placeholder="Filtrer l'historique">
      <div class="right">
        <button id="mExp" class="ghost admin-only">Export XLSX</button>
        <button id="mPurge" class="danger admin-only">Purger l'historique (agence courante)</button>
      </div>
    </div>
    <div class="table-wrap card" style="max-height:360px">
      <table id="mTbl"><thead><tr><th>Date</th><th>Type</th><th>Agence</th><th>Réf</th><th>Taille</th><th>Qté</th><th>Vers</th><th>Dest.</th><th>Motif</th><th>Note</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <!-- Stats -->
  <div id="tab-stats" class="card hidden">
    <h3>Statistiques</h3>
    <div class="grid g3">
      <input id="sFrom" type="date">
      <input id="sTo" type="date">
      <div>
        <label>Agences</label>
        <select id="sAgencies" multiple size="6"></select>
        <button id="sAll" class="ghost" style="margin-top:6px">TOUT</button>
      </div>
      <button id="sRun" class="primary">Calculer</button>
    </div>
    <div class="table-wrap card" style="max-height:420px">
      <table id="sTbl"><thead><tr><th>Référence</th><th>Article</th><th>Famille</th><th>Catégorie</th><th>Stock (sélection)</th><th>Valorisation</th><th>Entrées</th><th>Sorties</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <!-- Admin -->
  <div id="tab-admin" class="card hidden">
    <h3>Administration</h3>
    <div class="grid g3">
      <div class="card">
        <h4>Agences</h4>
        <div class="grid"><input id="aNew" placeholder="Nouvelle agence"><button id="aAdd">Ajouter</button></div>
        <ul id="aList"></ul>
      </div>
      <div class="card">
        <h4>Utilisateurs</h4>
        <div class="grid">
          <input id="uUser" placeholder="Identifiant">
          <input id="uPass" placeholder="Mot de passe">
          <select id="uRole"><option value="admin">admin</option><option value="agence">agence</option></select>
          <label>Agences autorisées</label>
          <select id="uAgs" multiple size="8"></select>
          <div class="grid g3">
            <button id="uSave" class="primary">Créer/Mettre à jour</button>
            <button id="uDel" class="danger">Supprimer</button>
          </div>
        </div>
        <table id="uTbl"><thead><tr><th>User</th><th>Rôle</th><th>Agences</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="card">
        <h4>Import / Export</h4>
        <div class="grid">
          <button id="eJSON">Export JSON complet</button>
          <input id="iJSON" type="file" accept=".json">
          <hr>
          <button id="eXLSX">Export Produits (FULL XLSX)</button>
          <input id="iXLSX" type="file" accept=".xlsx">
        </div>
      </div>
    </div>
  </div>

</div>

<footer>ARTEMIS Security — Cloud Firestore par défaut, fallback local si indisponible.</footer>

<script>
// ====== CONFIG ======
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAH29rfTBpssIurraLagSnE-a1nHRpfVOw",
  authDomain: "gestion-des-stocks-8e1b9.firebaseapp.com",
  projectId: "gestion-des-stocks-8e1b9"
};
const DEFAULT_AGENCIES = ["HAUT DE FRANCE","IDF","GRAND EST","RHONE ALPES","PACA","OCCITANIE","NOUVELLE AQUITAINE","AUTRE","DEPOT"];
const FAMILIES = ["Uniformes","EPI","Communication","Roulant","Informatique","Licences","Divers"];
const CATEGORIES = ["Uniformes","Tenues EPI","Matériel de communication","Matériel Roulant","Matériel informatique","Licences informatiques","Divers"];
const SIZES = ["XS","S","M","L","XL","2XL","3XL","4XL"];

// ====== HELPERS ======
const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
function money(n){ return (n||0).toLocaleString('fr-FR',{style:'currency',currency:'EUR'}); }
async function readAsDataURL(f){ return await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); }); }

// ====== STORAGE (Firestore + local fallback) ======
const DB = { users:"users", agencies:"agencies", products:"products", stock:"stock", moves:"movements", dict:"dict" };
let Store=null;
function LocalStore(){
  return {
    async init(){ localforage.config({name:"artemis-stock"}); if(!await localforage.getItem(DB.users)) await this.seed(); },
    async seed(){
      await localforage.setItem(DB.users,[
        {user:"ARTEMIS",pass:"Simetra",role:"admin",agencies:DEFAULT_AGENCIES},
        {user:"admin",pass:"admin",role:"admin",agencies:DEFAULT_AGENCIES},
        {user:"demo",pass:"demo",role:"agence",agencies:["IDF","DEPOT"]}
      ]);
      await localforage.setItem(DB.agencies, DEFAULT_AGENCIES);
      await localforage.setItem(DB.products, []);
      await localforage.setItem(DB.stock, {});
      await localforage.setItem(DB.moves, []);
      await localforage.setItem(DB.dict, {destinataires:["Client","Agence","Formation"], motifs:["Habillage","Remplacement","Casse"]});
    },
    async get(k){ return await localforage.getItem(k); },
    async set(k,v){ return await localforage.setItem(k,v); }
  };
}
function FireStore(){
  const app = firebase.initializeApp(FIREBASE_CONFIG);
  const db = firebase.firestore();
  const doc = db.collection("artemis-stock").doc("v1");
  return {
    async init(){ const s=await doc.get(); if(!s.exists) await this.seed(); },
    async seed(){ await doc.set({
      [DB.users]: [
        {user:"ARTEMIS",pass:"Simetra",role:"admin",agencies:DEFAULT_AGENCIES},
        {user:"admin",pass:"admin",role:"admin",agencies:DEFAULT_AGENCIES},
        {user:"demo",pass:"demo",role:"agence",agencies:["IDF","DEPOT"]}
      ],
      [DB.agencies]: DEFAULT_AGENCIES,
      [DB.products]: [],
      [DB.stock]: {},
      [DB.moves]: [],
      [DB.dict]: {destinataires:["Client","Agence","Formation"], motifs:["Habillage","Remplacement","Casse"]}
    },{merge:true}); },
    async get(k){ const d=(await doc.get()).data()||{}; return d[k]; },
    async set(k,v){ await doc.set({[k]:v},{merge:true}); return v; }
  };
}
async function initStore(){
  try{ Store=FireStore(); await Store.init(); }
  catch(e){ Store=LocalStore(); await Store.init(); }
}

// ====== AUTH ======
let session = { user:null, role:null, agencies:[], agency:null };
async function login(u,p){
  const users = await Store.get(DB.users) || [];
  const f = users.find(x=>x.user===u && x.pass===p);
  if(!f) return false;
  session.user=f.user; session.role=f.role; session.agencies=Array.isArray(f.agencies)?f.agencies:[f.agency||DEFAULT_AGENCIES[0]]; session.agency=session.agencies[0]||DEFAULT_AGENCIES[0];
  return true;
}
function logout(){ session={ user:null, role:null, agencies:[], agency:null }; }

// ====== THRESHOLDS ======
function getMinGlobal(p, agency){
  const base = Number(p.minGlobal||0);
  const ag = p.perAgencyMin && p.perAgencyMin[agency];
  return (ag && typeof ag.min==='number') ? Number(ag.min) : base;
}
function getMinSize(p, agency, size){
  const ag = p.perAgencyMin && p.perAgencyMin[agency];
  if(ag && ag.minBySize && ag.minBySize[size]!=null) return Number(ag.minBySize[size]||0);
  if(p.minBySize && p.minBySize[size]!=null) return Number(p.minBySize[size]||0);
  return 0;
}
function underThreshold(p, st, agency){
  const sizes = new Set([ ...(p.minBySize?Object.keys(p.minBySize):[]), ...(p.perAgencyMin?.[agency]?.minBySize?Object.keys(p.perAgencyMin[agency].minBySize):[]) ]);
  for(const s of sizes){
    const min = getMinSize(p, agency, s);
    if(min>0 && (st.sizes?.[s]||0) < min) return true;
  }
  const mg = getMinGlobal(p, agency);
  if(mg>0 && (st.total||0) < mg) return true;
  return false;
}

// ====== UI TABS ======
const TABS=[{id:"catalogue",label:"Catalogue"},{id:"prodit",label:"Fiche produit"},{id:"mv",label:"Mouvements"},{id:"stats",label:"Stats"},{id:"admin",label:"Admin",admin:true}];
function renderTabs(){
  const c=$("#tabs"); c.innerHTML="";
  TABS.forEach(t=>{
    if(t.admin && session.role!=="admin") return;
    const b=document.createElement("button"); b.textContent=t.label; b.dataset.tab=t.id; b.className="ghost";
    b.onclick=()=>switchTab(t.id); c.appendChild(b);
  });
}
function switchTab(id){
  ["catalogue","prodit","mv","stats","admin"].forEach(x=>$("#tab-"+x)?.classList.add("hidden"));
  document.querySelectorAll("#tabs button").forEach(b=>b.classList.remove("active"));
  $("#tab-"+id).classList.remove("hidden");
  document.querySelector(`#tabs button[data-tab='${id}']`)?.classList.add("active");
  if(id==="catalogue") loadCatalogue();
  if(id==="mv") loadMoves();
  if(id==="stats") prepStats();
  if(id==="admin") loadAdmin();
}

// ====== HEADER AGENCY SWITCH ======
async function fillAgencySwitch(){
  const sw=$("#agencySwitch"); const all=await Store.get(DB.agencies)||[];
  const allowed = (session.role==="admin")?all:(session.agencies||[]).filter(a=>all.includes(a));
  sw.innerHTML=""; allowed.forEach(a=>{ const o=document.createElement("option"); o.value=a; o.text=a; sw.add(o); });
  session.agency = allowed.includes(session.agency) ? session.agency : (allowed[0]||all[0]);
  sw.value = session.agency;
  sw.classList.toggle("hidden", allowed.length<=1 && session.role!=="admin");
  sw.onchange = ()=>{ session.agency=sw.value; $("#bAgency").textContent=session.agency; loadCatalogue(); loadMoves(); };
}

// ====== LOGIN ======
$("#btnLogin").onclick = async ()=>{
  if(!await login($("#lUser").value.trim(), $("#lPass").value.trim())) return alert("Identifiants invalides.");
  $("#login").classList.add("hidden"); $("#hdr").classList.remove("hidden"); $("#app").classList.remove("hidden");
  $("#bAgency").textContent=session.agency; $("#bRole").textContent=session.role;
  document.querySelectorAll(".admin-only").forEach(e=>e.classList.toggle("hidden", session.role!=="admin"));
  renderTabs(); fillAgencySwitch(); switchTab("catalogue");
};
$("#btnLogout").onclick = ()=>{ logout(); location.reload(); };

// ====== CATALOGUE (pagination + inline) ======
let catPage=1, catPageSize=20, catRows=[];
function inline(val, ref, field){ return `<span class="cell" data-ref="${ref}" data-field="${field}" contenteditable="true">${val??""}</span>`; }
function uniq(arr){ return Array.from(new Set(arr.filter(Boolean))); }
async function loadCatalogue(){
  const products=await Store.get(DB.products)||[]; const stock=await Store.get(DB.stock)||{};
  // filters
  $("#fFamily").innerHTML = "<option value=''>Toutes familles</option>" + uniq(products.map(p=>p.family)).map(v=>`<option>${v}</option>`).join("");
  $("#fCategory").innerHTML = "<option value=''>Toutes catégories</option>" + CATEGORIES.map(v=>`<option>${v}</option>`).join("");
  const agSel=$("#fAgencies"); agSel.innerHTML=""; const all=await Store.get(DB.agencies)||[];
  const allowed=(session.role==="admin")?all:(session.agencies||[]).filter(a=>all.includes(a));
  allowed.forEach(a=>{ const o=document.createElement("option"); o.text=a; o.value=a; agSel.add(o); });
  $("#fAll").onclick=()=>{ Array.from(agSel.options).forEach(o=>o.selected=true); render(); };
  $("#fPageSize").onchange=()=>{ catPageSize=Number($("#fPageSize").value||20); catPage=1; render(); };
  $("#fSearch").oninput=render; $("#fFamily").onchange=render; $("#fCategory").onchange=render; $("#fAgencies").onchange=render; $("#fReassort").onchange=render;
  $("#pPrev").onclick=()=>{ if(catPage>1){catPage--; render();} };
  $("#pNext").onclick=()=>{ const pages=Math.max(1, Math.ceil(catRows.length/catPageSize)); if(catPage<pages){catPage++; render();} };

  function selAg(){ const s=Array.from(agSel.selectedOptions).map(o=>o.value); return s.length?s:[session.agency]; }
  function stockSel(ref, ags){ let t=0; ags.forEach(a=> t += (stock[a]?.[ref]?.total)||0 ); return t; }
  function stockAll(ref){ let t=0; Object.keys(stock).forEach(a=> t += (stock[a]?.[ref]?.total)||0 ); return t; }

  function kpis(rows){
    $("#kTotal").textContent = products.length;
    let valoSel=0, valoAll=0, under=0;
    for(const r of rows){
      valoSel += r.stSel * Number(r.p.price||0);
      valoAll += r.stAll * Number(r.p.price||0);
      const cur = (stock[session.agency]||{})[r.p.ref]||{total:0,sizes:{}};
      if(underThreshold(r.p, cur, session.agency)) under++;
    }
    $("#kValo").textContent = money(valoSel); $("#kValoAll").textContent = money(valoAll); $("#kLow").textContent = under;
  }

  async function saveInline(ref, field, value){
    const list=await Store.get(DB.products)||[]; const i=list.findIndex(x=>x.ref===ref); if(i<0) return;
    if(field==="price") list[i].price = Number(value||0);
    if(field==="affectation") list[i].affectation = String(value||"").trim();
    await Store.set(DB.products, list);
  }

  function bindInline(){
    $$("#catTbl [data-ref][data-field]").forEach(el=>{
      el.addEventListener("keydown",ev=>{ if(ev.key==="Enter"){ev.preventDefault(); ev.target.blur();} });
      el.addEventListener("blur", async ev=>{ await saveInline(ev.target.dataset.ref, ev.target.dataset.field, ev.target.innerText); kpis(catRows); });
    });
  }

  function render(){
    const fam=$("#fFamily").value, cat=$("#fCategory").value, q=($("#fSearch").value||"").toLowerCase(), needR=$("#fReassort").value==="1";
    const ags=selAg(); const body=$("#catTbl tbody"); body.innerHTML="";
    catRows=[];
    for(const p of products){
      if(fam && p.family!==fam) continue;
      if(cat && p.category!==cat) continue;
      const fields=[p.ref,p.name,p.family,p.category,(p.barcode||""),(p.affectation||"")].join(" ").toLowerCase();
      if(q && !fields.includes(q)) continue;
      const stSel=stockSel(p.ref, ags), stAll=stockAll(p.ref);
      const stCur=(stock[session.agency]||{})[p.ref]||{total:0,sizes:{}};
      const isU=underThreshold(p, stCur, session.agency);
      if(needR && !isU) continue;
      catRows.push({p, stSel, stAll, isU});
    }
    const pages=Math.max(1, Math.ceil(catRows.length/catPageSize));
    if(catPage>pages) catPage=pages;
    $("#pInfo").textContent = catPage + "/" + pages;
    const start=(catPage-1)*catPageSize, end=start+catPageSize;
    const slice=catRows.slice(start,end);
    slice.forEach(({p,stSel,stAll,isU})=>{
      const tr=document.createElement("tr");
      if(isU) tr.className = stSel>0 ? "warn" : "alert";
      tr.innerHTML = `<td>${p.ref}</td><td>${p.name||""}</td><td>${p.family||""}</td><td>${p.category||""}</td>
        <td>${inline(p.price, p.ref, "price")}</td>
        <td>${stSel||0}</td><td class="admin-only">${stAll||0}</td>
        <td>G:${getMinGlobal(p, session.agency)||0}</td>
        <td>${p.barcode||""}</td>
        <td>${inline(p.affectation||"", p.ref, "affectation")}</td>
        <td><button class="ghost" data-open="${p.ref}">Ouvrir</button></td>`;
      body.appendChild(tr);
    });
    $$("button[data-open]").forEach(b=> b.onclick=()=>openProduct(b.dataset.open));
    document.querySelectorAll(".admin-only").forEach(e=>e.classList.toggle("hidden", session.role!=="admin"));
    kpis(slice.length?slice:catRows);
    bindInline();
  }

  render();

  // Export/Import Produits XLSX (avec seuils par agence optionnels + glossaire)
  $("#expX").onclick = async ()=>{
    const list=await Store.get(DB.products)||[];
    const rows=list.map(p=>({
      ref:p.ref,name:p.name,family:p.family||"",category:p.category||"",price:p.price||0,vendor:p.vendor||"",barcode:p.barcode||"",affectation:p.affectation||"",minGlobal:p.minGlobal||0,
      XS:p.minBySize?.XS||"",S:p.minBySize?.S||"",M:p.minBySize?.M||"",L:p.minBySize?.L||"",XL:p.minBySize?.XL||"",_2XL:p.minBySize?.["2XL"]||"",_3XL:p.minBySize?.["3XL"]||"",_4XL:p.minBySize?.["4XL"]||"",
      notes:p.notes||""
    }));
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rows), "Produits");
    // SeuilsAgences
    const agRows=[]; list.forEach(p=>{
      if(p.perAgencyMin){ for(const [ag,obj] of Object.entries(p.perAgencyMin)){
        agRows.push({ref:p.ref,agency:ag,min:obj.min||0,XS:obj.minBySize?.XS||"",S:obj.minBySize?.S||"",M:obj.minBySize?.M||"",L:obj.minBySize?.L||"",XL:obj.minBySize?.XL||"",_2XL:obj.minBySize?.["2XL"]||"",_3XL:obj.minBySize?.["3XL"]||"",_4XL:obj.minBySize?.["4XL"]||""});
      }}
    });
    if(agRows.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(agRows), "SeuilsAgences");
    // Glossaire
    const dict=await Store.get(DB.dict)||{destinataires:[], motifs:[]};
    const drows=[]; (dict.destinataires||[]).forEach(v=>drows.push({type:"destinataire",value:v})); (dict.motifs||[]).forEach(v=>drows.push({type:"motif",value:v}));
    if(drows.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(drows), "DestinatairesMotifs");
    XLSX.writeFile(wb,"produits_full.xlsx");
  };
  $("#impX").onchange = async (e)=>{
    const f=e.target.files[0]; if(!f) return; const data=await f.arrayBuffer(); const wb=XLSX.read(data,{type:"array"});
    const list=await Store.get(DB.products)||[]; const idx=new Map(list.map((p,i)=>[p.ref,i]));
    const sh=wb.Sheets["Produits"]; if(!sh) return alert('Feuille "Produits" introuvable');
    const rows=XLSX.utils.sheet_to_json(sh);
    rows.forEach(r=>{
      if(!r.ref) return;
      const rec={ref:String(r.ref),name:r.name||"",family:r.family||"",category:r.category||"",price:Number(r.price||0),vendor:r.vendor||"",barcode:r.barcode||"",affectation:r.affectation||"",minGlobal:Number(r.minGlobal||0),notes:r.notes||""};
      const minBySize={}; if(r.XS) minBySize.XS=Number(r.XS); if(r.S) minBySize.S=Number(r.S); if(r.M) minBySize.M=Number(r.M); if(r.L) minBySize.L=Number(r.L); if(r.XL) minBySize.XL=Number(r.XL); if(r._2XL) minBySize["2XL"]=Number(r._2XL); if(r._3XL) minBySize["3XL"]=Number(r._3XL); if(r._4XL) minBySize["4XL"]=Number(r._4XL);
      if(Object.keys(minBySize).length) rec.minBySize=minBySize;
      if(idx.has(rec.ref)) list[idx.get(rec.ref)]=Object.assign(list[idx.get(rec.ref)], rec); else list.push(rec);
    });
    const sag=wb.Sheets["SeuilsAgences"]; if(sag){ const ar=XLSX.utils.sheet_to_json(sag); ar.forEach(r=>{
      if(!r.ref||!r.agency) return; const i=list.findIndex(p=>p.ref==String(r.ref)); if(i<0) return;
      list[i].perAgencyMin=list[i].perAgencyMin||{}; const obj=list[i].perAgencyMin[r.agency]=list[i].perAgencyMin[r.agency]||{};
      obj.min=Number(r.min||0); const sz={}; if(r.XS) sz.XS=Number(r.XS); if(r.S) sz.S=Number(r.S); if(r.M) sz.M=Number(r.M); if(r.L) sz.L=Number(r.L); if(r.XL) sz.XL=Number(r.XL); if(r._2XL) sz["2XL"]=Number(r._2XL); if(r._3XL) sz["3XL"]=Number(r._3XL); if(r._4XL) sz["4XL"]=Number(r._4XL); if(Object.keys(sz).length) obj.minBySize=sz;
    })}
    const dsh=wb.Sheets["DestinatairesMotifs"]; if(dsh){ const dr=XLSX.utils.sheet_to_json(dsh); const dict=await Store.get(DB.dict)||{destinataires:[],motifs:[]}; dict.destinataires=dr.filter(x=>String(x.type).toLowerCase()=="destinataire").map(x=>x.value).filter(Boolean); dict.motifs=dr.filter(x=>String(x.type).toLowerCase()=="motif").map(x=>x.value).filter(Boolean); await Store.set(DB.dict, dict); }
    await Store.set(DB.products, list); alert("Import terminé"); loadCatalogue(); refreshMvRefs(); refreshDicts();
  };
}

// ====== Product form ======
function buildSizeInputs(rootSel){
  const w=$(rootSel); w.innerHTML=""; SIZES.forEach(s=>{ const d=document.createElement("div"); d.innerHTML=`<label>${s}</label><input type="number" min="0" step="1" data-minsize="${s}" placeholder="0">`; w.appendChild(d); });
}
$("#pSizesToggle").onchange=()=> $("#pSizesWrap").classList.toggle("hidden", !$("#pSizesToggle").checked);
async function openProduct(ref){
  const list=await Store.get(DB.products)||[]; const p=list.find(x=>x.ref===ref)||null;
  $("#pTitle").textContent = ref ? "Fiche produit — "+ref : "Nouveau produit";
  $("#pFamily").innerHTML = FAMILIES.map(v=>`<option>${v}</option>`).join("");
  $("#pCategory").innerHTML = CATEGORIES.map(v=>`<option>${v}</option>`).join("");
  buildSizeInputs("#pSizesWrap");
  if(!p){
    ["#pRef","#pName","#pPrice","#pVendor","#pBarcode","#pAffectation","#pMinGlobal","#pNotes"].forEach(s=>$(s).value="");
    $("#pPhotoPrev").classList.add("hidden"); $("#pTechLink").classList.add("hidden"); $("#btnDelP").classList.add("hidden"); $("#pSizesToggle").checked=false; $("#pSizesWrap").classList.add("hidden");
  }else{
    $("#pRef").value=p.ref; $("#pName").value=p.name||""; $("#pFamily").value=p.family||FAMILIES[0]; $("#pCategory").value=p.category||CATEGORIES[0];
    $("#pPrice").value=p.price||""; $("#pVendor").value=p.vendor||""; $("#pBarcode").value=p.barcode||""; $("#pAffectation").value=p.affectation||""; $("#pMinGlobal").value=p.minGlobal||""; $("#pNotes").value=p.notes||"";
    if(p.minBySize){ $("#pSizesToggle").checked=true; $("#pSizesWrap").classList.remove("hidden"); Object.entries(p.minBySize).forEach(([k,v])=>{ const i=document.querySelector(`#pSizesWrap [data-minsize='${k}']`); if(i) i.value=v; }); }
    if(p.photo){ $("#pPhotoPrev").src=p.photo; $("#pPhotoPrev").classList.remove("hidden"); }
    if(p.tech){ $("#pTechLink").href=p.tech.url; $("#pTechLink").textContent=p.tech.name||"Fiche technique"; $("#pTechLink").classList.remove("hidden"); }
    $("#btnDelP").classList.remove("hidden");
  }
  switchTab("prodit");
}
$("#btnNewP").onclick=()=>openProduct(null);
$("#pPhoto").onchange=async e=>{ const f=e.target.files[0]; if(!f) return; const url=await readAsDataURL(f); $("#pPhotoPrev").src=url; $("#pPhotoPrev").classList.remove("hidden"); };
$("#pTech").onchange=async e=>{ const f=e.target.files[0]; if(!f) return; const url=await readAsDataURL(f); $("#pTechLink").href=url; $("#pTechLink").textContent=f.name; $("#pTechLink").classList.remove("hidden"); };
$("#btnSaveP").onclick=async ()=>{
  const ref=$("#pRef").value.trim(); if(!ref) return alert("Référence requise");
  const list=await Store.get(DB.products)||[]; const i=list.findIndex(x=>x.ref===ref);
  const rec = {
    ref, name:$("#pName").value.trim(), family:$("#pFamily").value, category:$("#pCategory").value, price:Number($("#pPrice").value||0),
    vendor:$("#pVendor").value.trim(), barcode:$("#pBarcode").value.trim(), affectation:$("#pAffectation").value.trim(),
    minGlobal:Number($("#pMinGlobal").value||0), notes:$("#pNotes").value.trim()
  };
  if($("#pSizesToggle").checked){ rec.minBySize={}; $$("#pSizesWrap [data-minsize]").forEach(i=>{ const n=Number(i.value||0); if(n>0) rec.minBySize[i.dataset.minsize]=n; }); }
  const img=$("#pPhotoPrev"); if(!img.classList.contains("hidden")) rec.photo=img.src;
  const a=$("#pTechLink"); if(!a.classList.contains("hidden")) rec.tech={url:a.href,name:a.textContent};
  if(i>=0) list[i]=Object.assign(list[i], rec); else list.push(rec);
  await Store.set(DB.products, list); alert("Enregistré"); switchTab("catalogue"); loadCatalogue(); refreshMvRefs();
};
$("#btnDelP").onclick=async ()=>{
  if(!confirm("Supprimer ce produit ?")) return;
  const ref=$("#pRef").value.trim(); const list=await Store.get(DB.products)||[];
  await Store.set(DB.products, list.filter(x=>x.ref!==ref)); alert("Supprimé"); switchTab("catalogue"); loadCatalogue(); refreshMvRefs();
};

// ====== Mouvements (dropdown destinataire/motif + multi-tailles) ======
function buildMvSizes(){
  $("#mSize").innerHTML="<option value=''>—</option>"+SIZES.map(s=>`<option>${s}</option>`).join("");
  const w=$("#mMultiWrap"); w.innerHTML=""; SIZES.forEach(s=>{ const d=document.createElement("div"); d.innerHTML=`<label>${s}</label><input type="number" min="0" step="1" data-mvsize="${s}" placeholder="0">`; w.appendChild(d); });
}
buildMvSizes();
async function refreshMvRefs(){
  const products=await Store.get(DB.products)||[]; const dl=$("#mRefList"); dl.innerHTML=""; const sel=$("#mRef"); sel.innerHTML="";
  products.forEach(p=>{ const o=document.createElement("option"); o.value=p.ref; o.label=p.ref+" — "+p.name; dl.appendChild(o); const s=document.createElement("option"); s.value=p.ref; s.text=p.ref+" — "+p.name; sel.add(s); });
  const ags=await Store.get(DB.agencies)||[]; const to=$("#mTo"); to.innerHTML=""; ags.forEach(a=>{ const o=document.createElement("option"); o.text=a; to.add(o); });
}
refreshMvRefs();
async function refreshDicts(){
  const dict=await Store.get(DB.dict)||{destinataires:[],motifs:[]};
  const d=$("#mDest"), m=$("#mMotif"); d.innerHTML=""; m.innerHTML="";
  (dict.destinataires||[]).forEach(v=>{ const o=document.createElement("option"); o.text=v; d.add(o); });
  (dict.motifs||[]).forEach(v=>{ const o=document.createElement("option"); o.text=v; m.add(o); });
}
refreshDicts();
$("#mType").onchange=()=> $("#mTo").classList.toggle("hidden", $("#mType").value!=="transfer");
$("#mRefSearch").oninput = e=>{
  const val=e.target.value; const ref=(/^[^—]+/.test(val))?val.split("—")[0].trim():val.trim();
  const opt=Array.from($("#mRef").options).find(o=>o.value===ref); if(opt) $("#mRef").value=opt.value;
};
$("#mMulti").onchange = ()=>{ const on=$("#mMulti").checked; $("#mMultiWrap").classList.toggle("hidden", !on); $("#mQty").disabled=on; $("#mSize").disabled=on; };
$("#mDestBtn").onclick = async ()=>{ const v=$("#mDestAdd").value.trim(); if(!v) return; const dict=await Store.get(DB.dict)||{destinataires:[],motifs:[]}; if(!dict.destinataires.includes(v)) dict.destinataires.push(v); await Store.set(DB.dict, dict); $("#mDestAdd").value=""; refreshDicts(); };
$("#mMotifBtn").onclick = async ()=>{ const v=$("#mMotifAdd").value.trim(); if(!v) return; const dict=await Store.get(DB.dict)||{destinataires:[],motifs:[]}; if(!dict.motifs.includes(v)) dict.motifs.push(v); await Store.set(DB.dict, dict); $("#mMotifAdd").value=""; refreshDicts(); };

$("#mAdd").onclick = async ()=>{
  const type=$("#mType").value; const ref=$("#mRef").value; if(!ref) return alert("Référence requise (catalogue).");
  const prod=(await Store.get(DB.products)||[]).find(p=>p.ref===ref); if(!prod) return alert("Produit introuvable (créez-le d'abord).");
  const stock=await Store.get(DB.stock)||{}; stock[session.agency]=stock[session.agency]||{}; stock[session.agency][ref]=stock[session.agency][ref]||{total:0,sizes:{}};
  const mv=await Store.get(DB.moves)||[];
  const dest=$("#mDest").value||"", motif=$("#mMotif").value||"", note=$("#mNote").value||"";
  const lines=[];
  if($("#mMulti").checked){ $$("#mMultiWrap [data-mvsize]").forEach(i=>{ const q=Number(i.value||0); if(q>0) lines.push({size:i.dataset.mvsize, qty:q}); }); if(!lines.length) return alert("Renseignez au moins une quantité par taille."); }
  else { const q=Number($("#mQty").value||0); if(q<=0) return alert("Quantité invalide"); lines.push({size:($("#mSize").value||null), qty:q}); }
  function addQty(obj,delta,sz){ obj.total=(obj.total||0)+delta; if(sz) obj.sizes[sz]=(obj.sizes[sz]||0)+delta; }

  for(const ln of lines){
    if(type==="in") addQty(stock[session.agency][ref], ln.qty, ln.size);
    else if(type==="out"){ addQty(stock[session.agency][ref], -ln.qty, ln.size); if(stock[session.agency][ref].total<0) stock[session.agency][ref].total=0; if(ln.size && stock[session.agency][ref].sizes[ln.size]<0) stock[session.agency][ref].sizes[ln.size]=0; }
    else if(type==="transfer"){
      const to=$("#mTo").value; if(!to) return alert("Choisir l'agence de destination"); addQty(stock[session.agency][ref], -ln.qty, ln.size);
      stock[to]=stock[to]||{}; stock[to][ref]=stock[to][ref]||{total:0,sizes:{}}; addQty(stock[to][ref], ln.qty, ln.size);
    }
    mv.push({date:new Date().toISOString().slice(0,19).replace('T',' '), type, agency:session.agency, ref, size:ln.size, qty:ln.qty, toAgency:(type==="transfer"?$("#mTo").value:""), dest, motif, note});
  }
  await Store.set(DB.stock, stock); await Store.set(DB.moves, mv);
  ["#mRef","#mRefSearch","#mQty","#mNote"].forEach(s=>$(s).value=""); $$("#mMultiWrap [data-mvsize]").forEach(i=>i.value="");
  loadMoves(); loadCatalogue();
};

$("#mFilter").oninput = loadMoves;
async function loadMoves(){
  const mv=await Store.get(DB.moves)||[]; const tbody=$("#mTbl tbody"); tbody.innerHTML="";
  const q=($("#mFilter").value||"").toLowerCase();
  for(const m of mv.slice().reverse()){
    if(m.agency!==session.agency && session.role!=="admin" && m.toAgency!==session.agency) continue;
    const hay=[m.type,m.agency,m.ref,m.size||"",m.dest||"",m.motif||"",m.note||"",String(m.qty)].join(" ").toLowerCase();
    if(q && !hay.includes(q)) continue;
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${m.date}</td><td>${m.type}</td><td>${m.agency}</td><td>${m.ref}</td><td>${m.size||""}</td><td>${m.qty}</td><td>${m.toAgency||""}</td><td>${m.dest||""}</td><td>${m.motif||""}</td><td>${m.note||""}</td>`;
    tbody.appendChild(tr);
  }
  document.querySelectorAll(".admin-only").forEach(e=>e.classList.toggle("hidden", session.role!=="admin"));
}

// ====== Stats (multi-agences) ======
function prepStats(){
  const today=new Date(); $("#sTo").valueAsDate=today; const from=new Date(today.getFullYear(),today.getMonth(),1); $("#sFrom").valueAsDate=from;
  (async ()=>{ const sel=$("#sAgencies"); sel.innerHTML=""; const all=await Store.get(DB.agencies)||[]; const allowed=(session.role==="admin")?all:session.agencies; allowed.forEach(a=>{ const o=document.createElement("option"); o.text=a; sel.add(o); }); $("#sAll").onclick=()=>{ Array.from(sel.options).forEach(o=>o.selected=true); }; })();
}
$("#sRun").onclick = async ()=>{
  const from=new Date($("#sFrom").value); const to=new Date($("#sTo").value); to.setHours(23,59,59,999);
  const agsSel = Array.from($("#sAgencies").selectedOptions).map(o=>o.value); const ags = agsSel.length?agsSel:[session.agency];
  const products=await Store.get(DB.products)||[]; const stock=await Store.get(DB.stock)||{}; const mv=await Store.get(DB.moves)||[];
  const tbody=$("#sTbl tbody"); tbody.innerHTML="";
  function stockSel(ref){ let t=0; ags.forEach(a=> t += (stock[a]?.[ref]?.total)||0 ); return t; }
  function inRange(m){ const d=new Date(m.date.replace(' ','T')); return d>=from && d<=to; }
  for(const p of products){
    const st=stockSel(p.ref);
    const entries = mv.filter(m=>m.ref===p.ref && inRange(m) && (m.type==="in" || (m.type==="transfer" && ags.includes(m.toAgency)))).reduce((a,b)=>a+b.qty,0);
    const outs = mv.filter(m=>m.ref===p.ref && inRange(m) && (m.type==="out" || (m.type==="transfer" && ags.includes(m.agency)))).reduce((a,b)=>a+b.qty,0);
    const tr=document.createElement("tr"); tr.innerHTML = `<td>${p.ref}</td><td>${p.name||""}</td><td>${p.family||""}</td><td>${p.category||""}</td><td>${st}</td><td>${money(st*Number(p.price||0))}</td><td>${entries}</td><td>${outs}</td>`;
    tbody.appendChild(tr);
  }
};

// ====== Admin (agencies CRUD, users multi-agencies) ======
async function loadAdmin(){
  if(session.role!=="admin") return switchTab("catalogue");
  const ags=await Store.get(DB.agencies)||[]; const ul=$("#aList"); ul.innerHTML="";
  ags.forEach(a=>{
    const li=document.createElement("li"); li.textContent=a+" ";
    const del=document.createElement("button"); del.textContent="Supprimer"; del.className="danger"; del.onclick=async ()=>{
      if(!confirm("Supprimer l'agence "+a+" ?")) return;
      const nag=ags.filter(x=>x!==a); await Store.set(DB.agencies, nag);
      const stock=await Store.get(DB.stock)||{}; delete stock[a]; await Store.set(DB.stock, stock);
      const users=await Store.get(DB.users)||[]; users.forEach(u=>{ if(Array.isArray(u.agencies)) u.agencies=u.agencies.filter(x=>x!==a); else if(u.agency===a) u.agency=nag[0]||""; });
      await Store.set(DB.users, users);
      alert("Agence supprimée"); fillAgencySwitch(); loadAdmin(); loadCatalogue();
    };
    li.appendChild(del); ul.appendChild(li);
  });

  const uTbl=$("#uTbl tbody"); uTbl.innerHTML=""; const users=await Store.get(DB.users)||[];
  users.forEach(u=>{ const tr=document.createElement("tr"); tr.innerHTML=`<td>${u.user}</td><td>${u.role}</td><td>${Array.isArray(u.agencies)?u.agencies.join(", "):(u.agency||"")}</td>`; uTbl.appendChild(tr); });

  const ms=$("#uAgs"); ms.innerHTML=""; ags.forEach(a=>{ const o=document.createElement("option"); o.text=a; ms.add(o); });

  $("#uSave").onclick = async ()=>{
    const user=$("#uUser").value.trim(), pass=$("#uPass").value.trim(), role=$("#uRole").value;
    if(!user||!pass) return alert("User/Mot de passe requis");
    const list=await Store.get(DB.users)||[]; const i=list.findIndex(x=>x.user===user);
    const allowed=Array.from(ms.selectedOptions).map(o=>o.value);
    const rec={user,pass,role,agencies:(role==="admin"?DEFAULT_AGENCIES:(allowed.length?allowed:DEFAULT_AGENCIES.slice(0,1)))};
    if(i>=0) list[i]=Object.assign(list[i], rec); else list.push(rec);
    await Store.set(DB.users, list); alert("Utilisateur enregistré"); loadAdmin();
  };
  $("#uDel").onclick = async ()=>{
    const user=$("#uUser").value.trim(); if(!user) return;
    const list=await Store.get(DB.users)||[]; await Store.set(DB.users, list.filter(x=>x.user!==user)); alert("Supprimé"); loadAdmin();
  };

  // Export/Import relai
  $("#eXLSX").onclick = ()=> $("#expX").click();
  $("#iXLSX").onchange = e=> $("#impX").onchange(e);
  $("#eJSON").onclick = async ()=>{
    const data={}; for(const k of Object.values(DB)) data[k]=await Store.get(k);
    const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="export_full.json"; a.click();
  };
  $("#iJSON").onchange = async (e)=>{
    const f=e.target.files[0]; if(!f) return; const txt=await f.text(); const data=JSON.parse(txt);
    for(const [k,v] of Object.entries(data)) if(Object.values(DB).includes(k)) await Store.set(k,v);
    alert("Import JSON terminé"); location.reload();
  };
}

// ====== INIT ======
(async function(){
  try{ const app=firebase.initializeApp(FIREBASE_CONFIG); await firebase.firestore().collection("t").limit(1).get(); }catch(e){}
  await initStore();
})();

// Tabs initial render
function bootTabs(){ const t=$("#tabs"); t.innerHTML=""; const cfg=[["catalogue","Catalogue"],["prodit","Fiche produit"],["mv","Mouvements"],["stats","Stats"]]; cfg.forEach(([id,lab])=>{ const b=document.createElement("button"); b.textContent=lab; b.className="ghost"; b.dataset.tab=id; b.onclick=()=>switchTab(id); t.appendChild(b); }); const bA=document.createElement("button"); bA.textContent="Admin"; bA.className="ghost admin-only"; bA.dataset.tab="admin"; bA.onclick=()=>switchTab("admin"); t.appendChild(bA); }
bootTabs();
</script>
</body>
</html>
