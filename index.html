<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GESTION DE STOCK — ARTEMIS security (CLOUD • ALL-IN-ONE • FIX)</title>
  <style>
    :root{--bg:#0f172a;--bg2:#0b1222;--card:#111827;--muted:#94a3b8;--accent:#22c55e;--text:#e5e7eb;--danger:#ef4444;--border:#1f2937}
    *{box-sizing:border-box}html,body{margin:0;height:100%;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    body{background:linear-gradient(180deg,#0b1222 0,#0f172a 30%,#0b1222 100%);color:var(--text)}
    header{display:flex;align-items:center;gap:12px;padding:16px;background:rgba(17,24,39,.85);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10}
    header img{height:40px;width:auto;border-radius:6px}header h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.3px}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#0b1222;border:1px solid var(--border);font-size:12px;color:#cbd5e1}
    .badge.warn{border-color:#c07a00;color:#ffb86b}.badge.alert{border-color:#a42828;color:#ff7b7b}
    .container{max-width:1200px;margin:0 auto;padding:24px}.card{background:rgba(17,24,39,.85);border:1px solid var(--border);border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.35);padding:20px;margin-bottom:16px}
    .grid{display:grid;gap:16px}.grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    @media(max-width:980px){.grid.cols-2,.grid.cols-3,.grid.cols-4{grid-template-columns:1fr}}
    input,select,button,textarea{background:#0b1222;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px}
    button{cursor:pointer;border:1px solid #1f2937;background:#111827}button.primary{background:linear-gradient(180deg,#10b981,#059669);border-color:#0ea5a4;color:#062b2b;font-weight:700}
    button.danger{background:linear-gradient(180deg,#ef4444,#b91c1c);border-color:#7f1d1d;color:#fff}button.ghost{background:transparent;border-color:#233046}
    table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden;border:1px solid var(--border)}th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
    th{background:#0b1222;color:#cbd5e1;position:sticky;top:0;z-index:1}tr:hover td{background:#0e162b}
    .kpi{display:flex;gap:12px;flex-wrap:wrap}.kpi .item{flex:1 1 200px;background:rgba(17,24,39,.85);border:1px solid var(--border);border-radius:12px;padding:12px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}.tabs button{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#0b1222;color:#cbd5e1}
    .tabs button.active{background:linear-gradient(180deg,#1f2937,#0b1222);border-color:#334155;color:#fff;font-weight:600}
    .login-wrap{max-width:620px;margin:10vh auto}.brand{text-align:left;margin-bottom:8px}.brand h2{margin:8px 0 0;font-weight:800;letter-spacing:.8px}
    small.muted{color:#94a3b8}.pill{padding:2px 8px;border-radius:9999px;border:1px solid var(--border);background:#0b1222;font-size:12px}
    .right{margin-left:auto}.hidden{display:none!important}footer{text-align:center;font-size:12px;padding:16px;color:#94a3b8}
    table .qty-warn{background:#3a2a00}table .qty-alert{background:#3a1111}
    #debugPanel{position:fixed;right:16px;bottom:16px;max-width:420px;background:#111827ee;border:1px solid #334155;border-radius:12px;padding:12px;font-size:12px;color:#e5e7eb;z-index:9999}
    #debugPanel h4{margin:0 0 6px 0;font-size:13px}#debugLog{max-height:160px;overflow:auto;border-top:1px solid #334155;margin-top:6px;padding-top:6px;}#debugPanel button{margin-top:6px}
  </style>

  <!-- Minimal libs via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>
  <script>dayjs.extend(dayjs_plugin_utc); dayjs.extend(dayjs_plugin_timezone);</script>
  <script src="https://cdn.jsdelivr.net/npm/localforage@1/dist/localforage.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <header class="hidden" id="appHeader">
    <img src="data:image/jpeg;base64,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" alt="ARTEMIS security">
    <h1 id="appTitle"></h1>
    <span class="badge" id="badgeAgency"></span>
    <span class="badge" id="badgeRole"></span>
    <span class="badge warn" id="badgeLow"></span>
    <div class="right flex">
      <button id="btnSwitchAgency" class="ghost">Changer d'agence</button>
      <button id="btnLogout" class="ghost">Déconnexion</button>
    </div>
  </header>

  <div class="login-wrap" id="loginView">
    <div class="card">
      <div id="debugPanel" class="hidden"><h4>Debug</h4><div id="debugStatus"></div><div id="debugLog"></div><button id="btnHideDebug" class="ghost">Masquer</button></div>
      <div class="brand">
        <img src="data:image/jpeg;base64,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" alt="ARTEMIS security" style="height:64px;border-radius:8px">
        <h2>Connexion</h2>
        <small class="muted">Veuillez vous connecter</small>
      </div>
      <div class="grid">
        <div class="flex"><button id="btnShowDebug" class="ghost">Afficher debug</button><button id="btnForceLocal" class="ghost right">Forcer mode local</button></div>
        <input id="loginUser" placeholder="Identifiant" autocomplete="username">
        <input id="loginPass" type="password" placeholder="Mot de passe" autocomplete="current-password">
        <button id="btnLogin" class="primary">Se connecter</button>
      </div>
    </div>
  </div>

  <div class="container hidden" id="appView">
    <div class="tabs" id="mainTabs"></div>
    <div id="tab-dashboard" class="tab card">
      <div class="kpi">
        <div class="item"><div>Total articles</div><div id="kpiTotalItems" style="font-size:24px;font-weight:700;"></div></div>
        <div class="item"><div>Valorisation stock</div><div id="kpiValo" style="font-size:24px;font-weight:700;"></div></div>
        <div class="item"><div>Articles sous seuil</div><div id="kpiUnder" style="font-size:24px;font-weight:700;"></div></div>
      </div>
      <hr>
      <div class="grid cols-2">
        <div>
          <h3>Recherche rapide</h3>
          <div class="flex">
            <input id="quickSearch" placeholder="Nom, référence, code-barres…">
            <button id="btnScan" class="ghost">Scanner</button>
          </div>
          <div id="qrRegion" class="hidden" style="margin-top:8px;"></div>
        </div>
        <div>
          <h3>Filtre</h3>
          <div class="grid cols-3">
            <select id="filterCategory"></select>
            <select id="filterReassort">
              <option value="">Tous</option>
              <option value="1">À réassort</option>
            </select>
            <button id="btnProposeReassort" class="primary">Proposer un réassort</button>
          </div>
        </div>
      </div>
      <div class="card">
        <table id="tblCatalogue">
          <thead>
            <tr>
              <th>Référence</th><th>Article</th><th>Catégorie</th><th>Prix achat</th><th>Stock (agence)</th><th>Seuil</th><th>Code-barres</th><th>Affectation</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="tab-produit" class="tab card hidden">
      <h3 id="formTitle">Nouvel article</h3>
      <div class="grid cols-3">
        <input id="pRef" placeholder="Référence">
        <input id="pName" placeholder="Libellé">
        <select id="pCategory"></select>
        <input id="pPrice" type="number" min="0" step="0.01" placeholder="Prix d'achat">
        <input id="pVendor" placeholder="Revendeur">
        <input id="pBarcode" placeholder="Code-barres / QR">
      </div>
      <div class="grid cols-3">
        <input id="pAffectation" placeholder="Affectation (libre)">
        <input id="pMinGlobal" type="number" min="0" step="1" placeholder="Seuil mini global">
        <label><input id="pSizesToggle" type="checkbox"> Seuils par taille (optionnels)</label>
      </div>
      <div id="sizesWrap" class="grid cols-4 hidden"></div>
      <div class="flex">
        <button id="btnSaveProduct" class="primary">Enregistrer</button>
        <button id="btnNewProduct" class="ghost">Nouveau</button>
        <div class="right">
          <button id="btnDeleteProduct" class="danger hidden">Supprimer</button>
        </div>
      </div>
    </div>

    <div id="tab-mouvements" class="tab card hidden">
      <h3>Mouvements (Entrées / Sorties / Transferts)</h3>
      <div class="grid cols-4">
        <select id="mvType">
          <option value="in">Entrée</option>
          <option value="out">Sortie</option>
          <option value="transfer">Transfert</option>
        </select>
        <input id="mvRef" placeholder="Référence produit">
        <input id="mvQty" type="number" min="1" step="1" placeholder="Quantité">
        <select id="mvSize"></select>
        <input id="mvNote" placeholder="Destinataire / motif (sortie), bon, etc.">
        <select id="mvToAgency" class="hidden"></select>
        <button id="btnAddMv" class="primary">Ajouter</button>
      </div>
      <hr>
      <div class="flex">
        <input id="histSearch" placeholder="Filtrer l'historique">
        <div class="right">
          <button id="btnExportMv" class="ghost admin-only">Export XLSX</button>
          <button id="btnPurge" class="danger admin-only">Purger l'historique (agence courante)</button>
        </div>
      </div>
      <div class="card" style="max-height:360px; overflow:auto;">
        <table id="tblMv">
          <thead><tr><th>Date</th><th>Type</th><th>Agence</th><th>Réf</th><th>Taille</th><th>Qté</th><th>Vers</th><th>Note</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="tab-stats" class="tab card hidden">
      <h3>Statistiques</h3>
      <div class="grid cols-4">
        <input id="stFrom" type="date">
        <input id="stTo" type="date">
        <select id="stAgency"></select>
        <button id="btnComputeStats" class="primary">Calculer</button>
      </div>
      <hr>
      <div class="card" style="max-height:360px; overflow:auto;">
        <table id="tblStats">
          <thead><tr><th>Référence</th><th>Article</th><th>Stock</th><th>Valorisation</th><th>Entrées</th><th>Sorties</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="tab-admin" class="tab card hidden">
      <h3>Administration</h3>
      <div class="grid cols-3">
        <div class="card">
          <h4>Agences</h4>
          <div class="flex">
            <input id="agNew" placeholder="Nouvelle agence">
            <button id="btnAddAgency">Ajouter</button>
          </div>
          <ul id="agList"></ul>
        </div>
        <div class="card">
          <h4>Utilisateurs</h4>
          <div class="grid">
            <input id="uUser" placeholder="Identifiant">
            <input id="uPass" placeholder="Mot de passe">
            <select id="uRole">
              <option value="admin">admin</option>
              <option value="agence">agence</option>
            </select>
            <select id="uAgency"></select>
            <div class="flex">
              <button id="btnCreateUser" class="primary">Créer/Mettre à jour</button>
              <button id="btnDeleteUser" class="danger">Supprimer</button>
            </div>
          </div>
          <hr>
          <table id="tblUsers"><thead><tr><th>User</th><th>Rôle</th><th>Agence</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="card">
          <h4>Import / Export (admin)</h4>
          <div class="grid">
            <button id="btnExportJSON">Export JSON complet</button>
            <input type="file" id="fileImportJSON" accept=".json">
            <hr>
            <button id="btnExportXLSX">Export Produits XLSX</button>
            <input type="file" id="fileImportXLSX" accept=".xlsx">
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>ALL-IN-ONE • Cloud Firestore par défaut (fallback local possible). Boutons et scripts inlinés.</footer>

  <script>
  // ======== CONFIG ========
  const STORAGE_PROVIDER = "firebase";
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyAH29rfTBpssIurraLagSnE-a1nHRpfVOw",
    authDomain: "gestion-des-stocks-8e1b9.firebaseapp.com",
    projectId: "gestion-des-stocks-8e1b9",
    storageBucket: "gestion-des-stocks-8e1b9.firebasestorage.app",
    messagingSenderId: "217955911455",
    appId: "1:217955911455:web:3120485f9bd8cadb29122a",
    measurementId: "G-VHH73188FZ"
  };
  const APP_TITLE = "GESTION DE STOCK — ARTEMIS security (CLOUD • ALL-IN-ONE • FIX)";
  const DEFAULT_AGENCIES = ["HAUT DE FRANCE","IDF","GRAND EST","RHONE ALPES","PACA","OCCITANIE","NOUVELLE AQUITAINE","AUTRE","DEPOT"];
  const CATEGORIES = ["Uniformes","Tenues EPI","Matériel de communication","Matériel Roulant","Matériel informatique","Licences informatiques","Divers"];
  const SIZES = ["XS","S","M","L","XL","2XL","3XL","4XL"];

  // ======== UTILS ========
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));
  function dbg(msg){ try{ console.log("[DBG]", msg); const log=$("#debugLog"); if (log){ const p=document.createElement("div"); p.textContent=(new Date()).toLocaleTimeString()+" — "+msg; log.appendChild(p); log.scrollTop=log.scrollHeight; } }catch(e){} }
  function dbgStatus(obj){ const s=$("#debugStatus"); if(!s) return; s.innerHTML = Object.entries(obj).map(([k,v])=>`<div><b>${k}</b>: ${String(v)}</div>`).join(""); }
  function showDebug(v){ $("#debugPanel")?.classList.toggle("hidden", !v); }
  let DEBUG_INFO = { provider:"", firestore:"not-initialized" };

  // Bind early
  document.addEventListener('DOMContentLoaded', () => {
    $("#btnShowDebug")?.addEventListener("click", ()=>{ showDebug(true); alert('Debug ON'); });
    $("#btnHideDebug")?.addEventListener("click", ()=> showDebug(false));
    $("#btnForceLocal")?.addEventListener("click", ()=>{ window.forceLocal = true; alert("Mode local forcé — rechargement"); location.reload(); });
    $("#btnLogin")?.addEventListener("click", onLoginClick);
    $("#btnLogout")?.addEventListener("click", ()=>{ logout(); location.reload(); });
  });

  // ======== STORE ========
  const DB_KEYS = { users:"users", agencies:"agencies", products:"products", stock:"stock", movements:"movements" };
  let Store = null;

  function createLocalStore(){
    return {
      async init(){
        localforage.config({name:"artemis-stock"});
        if(!await localforage.getItem(DB_KEYS.users)) await this.seed();
      },
      async seed(){
        await localforage.setItem(DB_KEYS.users,[
          {user:"ARTEMIS",pass:"Simetra",role:"admin",agency:"IDF"},
          {user:"admin",pass:"admin",role:"admin",agency:"IDF"},
          {user:"demo",pass:"demo",role:"agence",agency:"IDF"}
        ]);
        await localforage.setItem(DB_KEYS.agencies, DEFAULT_AGENCIES);
        await localforage.setItem(DB_KEYS.products, []);
        await localforage.setItem(DB_KEYS.stock, {});
        await localforage.setItem(DB_KEYS.movements, []);
      },
      async get(k){ return await localforage.getItem(k); },
      async set(k,v){ return await localforage.setItem(k,v); }
    };
  }

  function createFirestoreStore(){
    const app = firebase.initializeApp(FIREBASE_CONFIG);
    const db = firebase.firestore();
    const root = db.collection("artemis-stock").doc("v1");
    return {
      async init(){
        try{
          const snap = await root.get();
          if(!snap.exists) await this.seed();
          DEBUG_INFO.firestore="ok"; dbg("Firestore ready"); dbgStatus(DEBUG_INFO);
        }catch(e){
          DEBUG_INFO.firestore=e && (e.message||e.code||"error"); dbg("Firestore error: "+DEBUG_INFO.firestore); dbgStatus(DEBUG_INFO); throw e;
        }
      },
      async seed(){ await root.set({
        [DB_KEYS.users]: [
          {user:"ARTEMIS",pass:"Simetra",role:"admin",agency:"IDF"},
          {user:"admin",pass:"admin",role:"admin",agency:"IDF"},
          {user:"demo",pass:"demo",role:"agence",agency:"IDF"}
        ],
        [DB_KEYS.agencies]: DEFAULT_AGENCIES,
        [DB_KEYS.products]: [],
        [DB_KEYS.stock]: {}, [DB_KEYS.movements]: []
      },{merge:true}); },
      async get(k){ const d=(await root.get()).data()||{}; return d[k]; },
      async set(k,v){ await root.set({[k]:v},{merge:true}); return v; }
    };
  }

  async function initStore(){
    dbg("Init store...");
    if (window.forceLocal){ DEBUG_INFO.provider='local-override'; Store=createLocalStore(); await Store.init(); dbgStatus(DEBUG_INFO); return; }
    if (STORAGE_PROVIDER==='firebase'){
      try{ Store=createFirestoreStore(); await Store.init(); DEBUG_INFO.provider='firestore'; dbg("Cloud Firestore actif"); dbgStatus(DEBUG_INFO); return; }
      catch(e){ DEBUG_INFO.provider='firestore-failed'; dbg("Firestore failed, will fallback local"); dbgStatus(DEBUG_INFO); }
    }
    Store=createLocalStore(); await Store.init(); if(!DEBUG_INFO.provider) DEBUG_INFO.provider='local'; dbg("Local actif"); dbgStatus(DEBUG_INFO);
  }

  // ======== AUTH ========
  let session = { user:null, role:null, agency:null };
  async function login(user,pass){ const users=await Store.get(DB_KEYS.users)||[]; const f=users.find(u=>u.user===user && u.pass===pass); if(!f) return false; session.user=f.user; session.role=f.role; session.agency=f.agency||DEFAULT_AGENCIES[0]; return true; }
  function logout(){ session={user:null,role:null,agency:null}; }
  async function onLoginClick(){ try{ dbg("Login click"); const u=$("#loginUser").value.trim(); const p=$("#loginPass").value.trim(); const ok=await login(u,p); dbg("Login result="+ok); if(!ok) return alert("Identifiants invalides."); afterLogin(); }catch(err){ alert("Erreur: "+(err&&err.message)); } }

  // ======== HELPERS ========
  async function ensureStockAgency(agency){ const stock=await Store.get(DB_KEYS.stock)||{}; if(!stock[agency]){ stock[agency]={}; await Store.set(DB_KEYS.stock,stock); } }
  async function getProductByRef(ref){ const ps=await Store.get(DB_KEYS.products)||[]; return ps.find(p=>p.ref===ref)||null; }
  function isUnderThreshold(p, st){ const mg=Number(p.minGlobal||0); if (mg && (st.total||0)<mg) return true; if (p.minBySize){ for(const sz of Object.keys(p.minBySize)){ const m=Number(p.minBySize[sz]||0); if(m>0 && (st.sizes?.[sz]||0)<m) return true; } } return false; }
  function money(n){ return (n||0).toLocaleString('fr-FR',{style:'currency',currency:'EUR'}); }

  function renderTabs(){ const cont=$("#mainTabs"); cont.innerHTML=""; const tabs=[
    {id:"dashboard",label:"Catalogue"},
    {id:"produit",label:"Fiche produit"},
    {id:"mouvements",label:"Mouvements"},
    {id:"stats",label:"Stats"},
    {id:"admin",label:"Admin",admin:true}
  ]; for(const t of tabs){ if(t.admin && session.role!=="admin") continue; const b=document.createElement("button"); b.textContent=t.label; b.dataset.tab=t.id; b.className="ghost"; b.addEventListener("click",()=>switchTab(t.id)); cont.appendChild(b); } }
  function switchTab(id){ $$(".tab").forEach(el=>el.classList.add("hidden")); $$(".tabs button").forEach(el=>el.classList.remove("active")); $("#tab-"+id).classList.remove("hidden"); const btn=$(".tabs button[data-tab='"+id+"']"); if(btn) btn.classList.add("active"); if(id==="dashboard") loadCatalogue(); if(id==="mouvements") loadMovements(); if(id==="stats") prepareStats(); if(id==="admin") loadAdmin(); }

  function afterLogin(){ $("#loginView").classList.add("hidden"); $("#appHeader").classList.remove("hidden"); $("#appView").classList.remove("hidden"); $("#appTitle").textContent=APP_TITLE; $("#badgeAgency").textContent=session.agency; $("#badgeRole").textContent=session.role; $("#btnSwitchAgency").classList.toggle("hidden", session.role!=="admin"); renderTabs(); switchTab("dashboard"); }
  $("#btnSwitchAgency")?.addEventListener("click", async ()=>{ if(session.role!=="admin") return; const ags=await Store.get(DB_KEYS.agencies)||[]; const pick=prompt("Basculer vers l'agence :", ags.join(", ")); if(!pick || !ags.includes(pick)) return; session.agency=pick; $("#badgeAgency").textContent=pick; switchTab("dashboard"); });

  async function loadCatalogue(){ await ensureStockAgency(session.agency); const products=await Store.get(DB_KEYS.products)||[]; const stock=await Store.get(DB_KEYS.stock)||{}; const stA=stock[session.agency]||{};
    const catSel=$("#filterCategory"); catSel.innerHTML="<option value=''>Toutes</option>"; CATEGORIES.forEach(c=>{ const o=document.createElement("option"); o.value=c; o.textContent=c; catSel.appendChild(o); });
    $("#kpiTotalItems").textContent=products.length; let valo=0; for (const p of products){ const q=(stA[p.ref]?.total)||0; valo+=q*Number(p.price||0); } $("#kpiValo").textContent=money(valo);
    const q=($("#quickSearch").value||"").toLowerCase(); const fcat=catSel.value; const reass=$("#filterReassort").value==="1"; const tbody=$("#tblCatalogue tbody"); tbody.innerHTML="";
    let under=0;
    for (const p of products){ const st=stA[p.ref]||{ total:0, sizes:{} }; const isU=isUnderThreshold(p,st); if(isU) under++; if (fcat && p.category!==fcat) continue; const fields=[p.ref,p.name,p.category,(p.barcode||""),(p.affectation||"")].join(" ").toLowerCase(); if (reass && !isU) continue; if (q && !fields.includes(q)) continue; const tr=document.createElement("tr"); if (isU) tr.classList.add(st.total>0 ? "qty-warn" : "qty-alert");
      tr.innerHTML = `<td>${p.ref}</td><td>${p.name}</td><td>${p.category}</td><td>${money(p.price)}</td><td>${st.total||0}</td><td>${p.minGlobal||""}</td><td>${p.barcode||""}</td><td>${p.affectation||""}</td><td><button class="ghost" data-open="${p.ref}">Ouvrir</button></td>`; tbody.appendChild(tr); }
    $("#kpiUnder").textContent=under; $("#badgeLow").textContent = under+" sous seuil";
    $$("button[data-open]").forEach(b=>b.onclick=()=>openProduct(b.dataset.open));
  }
  $("#quickSearch")?.addEventListener("input", loadCatalogue);
  $("#filterCategory")?.addEventListener("change", loadCatalogue);
  $("#filterReassort")?.addEventListener("change", loadCatalogue);

  function buildSizesInputs(){ const wrap=$("#sizesWrap"); wrap.innerHTML=""; for (const s of SIZES){ const div=document.createElement("div"); div.innerHTML = `<label>${s} seuil</label><input type="number" min="0" step="1" data-minsize="${s}" placeholder="0">`; wrap.appendChild(div); } }
  $("#pSizesToggle")?.addEventListener("change", ()=>{ $("#sizesWrap").classList.toggle("hidden", !$("#pSizesToggle").checked); });
  $("#btnNewProduct")?.addEventListener("click", ()=> openProduct(null));
  function openProduct(ref){ $("#formTitle").textContent = ref ? `Article ${ref}` : "Nouvel article"; const cat = $("#pCategory"); cat.innerHTML = CATEGORIES.map(c=>`<option>${c}</option>`).join(""); buildSizesInputs(); $("#btnDeleteProduct").classList.toggle("hidden", !ref);
    if (!ref){ $("#pRef").value=""; $("#pName").value=""; $("#pPrice").value=""; $("#pVendor").value=""; $("#pBarcode").value=""; $("#pAffectation").value=""; $("#pMinGlobal").value=""; $("#pSizesToggle").checked=false; $("#sizesWrap").classList.add("hidden"); switchTab("produit"); return; }
    (async ()=>{ const p = await getProductByRef(ref); if (!p) return;
      $("#pRef").value = p.ref; $("#pName").value=p.name; $("#pCategory").value=p.category; $("#pPrice").value=p.price||""; $("#pVendor").value=p.vendor||""; $("#pBarcode").value=p.barcode||""; $("#pAffectation").value=p.affectation||""; $("#pMinGlobal").value=p.minGlobal||"";
      if (p.minBySize){ $("#pSizesToggle").checked=true; $("#sizesWrap").classList.remove("hidden"); for (const s of Object.keys(p.minBySize)){ const inp = document.querySelector(`[data-minsize='${s}']`); if (inp) inp.value=p.minBySize[s]; } }
      else { $("#pSizesToggle").checked=false; $("#sizesWrap").classList.add("hidden"); }
      switchTab("produit");
    })();
  }
  $("#btnSaveProduct")?.addEventListener("click", async ()=>{
    const ref = $("#pRef").value.trim(); if (!ref) return alert("Référence requise");
    const products = await Store.get(DB_KEYS.products) || [];
    const existing = products.findIndex(x=>x.ref===ref);
    const p = {
      ref,
      name: $("#pName").value.trim(),
      category: $("#pCategory").value,
      price: Number($("#pPrice").value||0),
      vendor: $("#pVendor").value.trim(),
      barcode: $("#pBarcode").value.trim(),
      affectation: $("#pAffectation").value.trim(),
      minGlobal: Number($("#pMinGlobal").value||0),
    };
    if ($("#pSizesToggle").checked){
      p.minBySize = {};
      document.querySelectorAll("[data-minsize]").forEach(inp=>{ const n = Number(inp.value||0); if (n>0) p.minBySize[inp.dataset.minsize]=n; });
    } else { delete p.minBySize; }
    if (existing>=0) products[existing] = p; else products.push(p);
    await Store.set(DB_KEYS.products, products);
    alert("Enregistré.");
    switchTab("dashboard");
    loadCatalogue();
  });
  $("#btnDeleteProduct")?.addEventListener("click", async ()=>{
    if (!confirm("Supprimer cet article ?")) return;
    const ref = $("#pRef").value.trim(); if (!ref) return;
    const products = await Store.get(DB_KEYS.products) || [];
    await Store.set(DB_KEYS.products, products.filter(x=>x.ref!==ref));
    alert("Supprimé."); switchTab("dashboard"); loadCatalogue();
  });

  function prepareMv(){
    const sel = $("#mvSize"); if(sel) sel.innerHTML = "<option value=''>—</option>" + SIZES.map(s=>`<option>${s}</option>`).join("");
  }
  prepareMv();
  $("#mvType")?.addEventListener("change", ()=>{ $("#mvToAgency").classList.toggle("hidden", $("#mvType").value!=="transfer"); });
  async function loadMovements(){
    await ensureStockAgency(session.agency);
    const mv = await Store.get(DB_KEYS.movements) || [];
    const tbody = $("#tblMv tbody"); tbody.innerHTML = "";
    const q = ($("#histSearch").value||"").toLowerCase();
    for (const m of mv.slice().reverse()){
      if (m.agency !== session.agency && session.role!=="admin") continue;
      const line = [m.type, m.agency, m.ref, m.size||"", m.note||"", String(m.qty)].join(" ").toLowerCase();
      if (q && !line.includes(q)) continue;
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${m.date}</td><td>${m.type}</td><td>${m.agency}</td><td>${m.ref}</td><td>${m.size||""}</td><td>${m.qty}</td><td>${m.toAgency||""}</td><td>${m.note||""}</td>`;
      tbody.appendChild(tr);
    }
    const agSel = $("#mvToAgency"); agSel.innerHTML = "";
    const ags = await Store.get(DB_KEYS.agencies) || [];
    ags.forEach(a=>{ const o=document.createElement("option"); o.text=a; agSel.add(o); });
    document.querySelectorAll(".admin-only").forEach(el=>el.classList.toggle("hidden", session.role!=="admin"));
  }
  $("#histSearch")?.addEventListener("input", loadMovements);

  $("#btnAddMv")?.addEventListener("click", async ()=>{
    const type = $("#mvType").value;
    const ref = $("#mvRef").value.trim(); if (!ref) return alert("Référence requise");
    const qty = Number($("#mvQty").value||0); if (qty<=0) return alert("Quantité invalide");
    const size = $("#mvSize").value||null;
    const note = $("#mvNote").value.trim();
    const toAgency = $("#mvToAgency").value;
    const prod = await getProductByRef(ref); if (!prod) return alert("Produit introuvable");
    const stock = await Store.get(DB_KEYS.stock) || {};
    await ensureStockAgency(session.agency);
    const stA = stock[session.agency] || {};
    stA[ref] = stA[ref] || { total:0, sizes:{} };
    function addQty(obj, delta){
      obj.total = (obj.total||0) + delta;
      if (size){ obj.sizes[size] = (obj.sizes[size]||0) + delta; }
    }
    if (type==="in"){
      addQty(stA[ref], qty);
    } else if (type==="out"){
      addQty(stA[ref], -qty);
      if (stA[ref].total<0) stA[ref].total=0;
      if (size && stA[ref].sizes[size]<0) stA[ref].sizes[size]=0;
    } else if (type==="transfer"){
      if (!toAgency) return alert("Choisir l'agence de destination.");
      addQty(stA[ref], -qty);
      stock[toAgency] = stock[toAgency] || {};
      stock[toAgency][ref] = stock[toAgency][ref] || { total:0, sizes:{} };
      function addTo(obj){ obj.total=(obj.total||0)+qty; if (size){ obj.sizes[size]=(obj.sizes[size]||0)+qty; } }
      addTo(stock[toAgency][ref]);
    }
    stock[session.agency] = stA;
    await Store.set(DB_KEYS.stock, stock);
    const movements = await Store.get(DB_KEYS.movements) || [];
    movements.push({
      date: new Date().toISOString().slice(0,19).replace('T',' '),
      type, agency: session.agency, ref, size, qty, toAgency: type==="transfer"?toAgency:"", note
    });
    await Store.set(DB_KEYS.movements, movements);
    $("#mvRef").value=""; $("#mvQty").value=""; $("#mvNote").value="";
    loadMovements(); loadCatalogue();
  });

  function prepareStats(){
    const today = new Date();
    $("#stTo").valueAsDate = today;
    const from = new Date(today.getFullYear(), today.getMonth(), 1);
    $("#stFrom").valueAsDate = from;
    (async ()=>{
      const agSel = $("#stAgency"); agSel.innerHTML="";
      const ags = await Store.get(DB_KEYS.agencies) || [];
      ags.forEach(a=>{ const o=document.createElement("option"); o.text=a; agSel.add(o); });
      agSel.value = session.agency;
    })();
  }
  $("#btnComputeStats")?.addEventListener("click", async ()=>{
    const from = new Date($("#stFrom").value);
    const to = new Date($("#stTo").value); to.setHours(23,59,59,999);
    const agency = $("#stAgency").value;
    const products = await Store.get(DB_KEYS.products) || [];
    const stock = await Store.get(DB_KEYS.stock) || {};
    const stA = stock[agency] || {};
    const mv = (await Store.get(DB_KEYS.movements) || []).filter(m=>{
      const d = new Date(m.date.replace(' ','T'));
      return d>=from && d<=to && (m.agency===agency || m.toAgency===agency);
    });
    const tbody = $("#tblStats tbody"); tbody.innerHTML="";
    for (const p of products){
      const st = stA[p.ref] || { total:0 };
      const entries = mv.filter(m=>m.ref===p.ref && (m.type==="in" || (m.type==="transfer"&&m.toAgency===agency))).reduce((a,b)=>a+b.qty,0);
      const outs = mv.filter(m=>m.ref===p.ref && (m.type==="out" || (m.type==="transfer"&&m.agency===agency))).reduce((a,b)=>a+b.qty,0);
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${p.ref}</td><td>${p.name}</td><td>${st.total||0}</td><td>${money((st.total||0)*Number(p.price||0))}</td><td>${entries}</td><td>${outs}</td>`;
      tbody.appendChild(tr);
    }
  });

  async function loadAdmin(){
    if (session.role!=="admin"){ switchTab("dashboard"); return; }
    const ags = await Store.get(DB_KEYS.agencies) || [];
    const ul = $("#agList"); ul.innerHTML="";
    ags.forEach(a=>{ const li=document.createElement("li"); li.textContent=a; ul.appendChild(li); });
    const uAgency = $("#uAgency"); uAgency.innerHTML=""; ags.forEach(a=>{ const o=document.createElement("option"); o.text=a; uAgency.add(o);} );
    const users = await Store.get(DB_KEYS.users) || [];
    const tbody = $("#tblUsers tbody"); tbody.innerHTML="";
    users.forEach(u=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${u.user}</td><td>${u.role}</td><td>${u.agency||""}</td>`;
      tbody.appendChild(tr);
    });
  }
  $("#btnAddAgency")?.addEventListener("click", async ()=>{
    const name = $("#agNew").value.trim(); if (!name) return;
    const ags = await Store.get(DB_KEYS.agencies) || [];
    if (!ags.includes(name)){ ags.push(name); await Store.set(DB_KEYS.agencies, ags); alert("Agence ajoutée."); loadAdmin(); }
  });
  $("#btnCreateUser")?.addEventListener("click", async ()=>{
    const user = $("#uUser").value.trim(); const pass=$("#uPass").value.trim();
    const role = $("#uRole").value; const agency=$("#uAgency").value;
    if (!user || !pass) return alert("User/Mot de passe requis.");
    const users = await Store.get(DB_KEYS.users) || [];
    const i = users.findIndex(u=>u.user===user);
    const rec = { user, pass, role, agency: role==="agence"?agency: (agency||DEFAULT_AGENCIES[0]) };
    if (i>=0) users[i]=rec; else users.push(rec);
    await Store.set(DB_KEYS.users, users); alert("OK"); loadAdmin();
  });
  $("#btnDeleteUser")?.addEventListener("click", async ()=>{
    const user = $("#uUser").value.trim(); if (!user) return;
    const users = await Store.get(DB_KEYS.users) || [];
    await Store.set(DB_KEYS.users, users.filter(u=>u.user!==user));
    alert("Supprimé"); loadAdmin();
  });

  $("#btnExportJSON")?.addEventListener("click", async ()=>{
    const dump = {}; for (const k of Object.values(DB_KEYS)) dump[k] = await Store.get(k);
    const blob = new Blob([JSON.stringify(dump,null,2)], {type:"application/json"});
    const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "export_artemis_stock.json"; a.click();
  });
  $("#fileImportJSON")?.addEventListener("change", async (e)=>{
    const file = e.target.files[0]; if (!file) return;
    const txt = await file.text();
    const data = JSON.parse(txt);
    for (const [k,v] of Object.entries(data)){
      if (Object.values(DB_KEYS).includes(k)) await Store.set(k, v);
    }
    alert("Import terminé."); location.reload();
  });
  $("#btnExportXLSX")?.addEventListener("click", async ()=>{
    const products = await Store.get(DB_KEYS.products) || [];
    const rows = products.map(p=>({ ref:p.ref, name:p.name, category:p.category, price:p.price, vendor:p.vendor, barcode:p.barcode, affectation:p.affectation, minGlobal:p.minGlobal }));
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Produits");
    XLSX.writeFile(wb, "produits.xlsx");
  });
  $("#fileImportXLSX")?.addEventListener("change", async (e)=>{
    const file = e.target.files[0]; if (!file) return;
    const data = await file.arrayBuffer();
    const wb = XLSX.read(data, {type:"array"});
    const sheet = wb.Sheets["Produits"];
    if (!sheet) return alert('Feuille "Produits" introuvable');
    const rows = XLSX.utils.sheet_to_json(sheet);
    const products = await Store.get(DB_KEYS.products) || [];
    const idx = new Map(products.map((p,i)=>[p.ref,i]));
    for (const r of rows){
      if (!r.ref) continue;
      const rec = {
        ref: String(r.ref),
        name: r.name||"",
        category: r.category||CATEGORIES[0],
        price: Number(r.price||0),
        vendor: r.vendor||"",
        barcode: r.barcode||"",
        affectation: r.affectation||"",
        minGlobal: Number(r.minGlobal||0)
      };
      if (idx.has(rec.ref)) products[idx.get(rec.ref)] = rec; else products.push(rec);
    }
    await Store.set(DB_KEYS.products, products);
    alert("Produits importés."); loadCatalogue();
  });

  (async function init(){
    await initStore();
    const catSel = $("#pCategory"); if (catSel) catSel.innerHTML = CATEGORIES.map(c=>`<option>${c}</option>`).join("");
    buildSizesInputs();
  })();
  </script>
</body>
</html>
